<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Automower Tracker</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="../static/leaflet/leaflet.css"/>

    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        #map {
            height: 100vh;
            width: 100%;
        }

        .controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: white;
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
        }

        .info-box {
            padding: 10px;
            background: white;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.2);
            max-width: 300px;
        }

        .info-box h4 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .info-box p {
            margin: 5px 0;
        }

        .battery-indicator {
            height: 10px;
            background-color: #4CAF50;
            border-radius: 5px;
        }

        .error {
            color: #f44336;
            font-weight: bold;
        }

        .view-options {
            margin-top: 10px;
            padding-top: 5px;
            border-top: 1px solid #eee;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div class="controls">
        <label for="time-range">Time Range:</label>
        <select id="time-range" onchange="updateMap()">
            <option value="1">Last hour</option>
            <option value="6">Last 6 hours</option>
            <option value="12">Last 12 hours</option>
            <option value="24" selected>Last 24 hours</option>
            <option value="48">Last 2 days</option>
            <option value="168">Last week</option>
        </select>

        <div id="mower-selector">
            <label for="mower-select">Mower:</label>
            <select id="mower-select" onchange="updateMap()">
                <option value="">All Mowers</option>
            </select>
        </div>

        <div class="view-options">
            <div>
                <label for="show-markers">Show GPS Points:</label>
                <input type="checkbox" id="show-markers" checked onchange="toggleMarkers()" />
            </div>

            <div>
                <label for="show-paths">Show Paths:</label>
                <input type="checkbox" id="show-paths" checked onchange="togglePaths()" />
            </div>

            <div>
                <label for="show-heatmap">Show Heatmap:</label>
                <input type="checkbox" id="show-heatmap" onchange="toggleHeatmap()" />
            </div>

            <div>
                <label for="heatmap-intensity">Heatmap Intensity:</label>
                <input type="range" id="heatmap-intensity" min="1" max="30" value="15" onchange="updateHeatmapIntensity(this.value)" />
            </div>
        </div>

        <div id="last-updated" style="margin-top: 10px; font-size: 0.8em; color: #666;">
            Last updated: Never
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="../static/leaflet/leaflet.js"></script>

    <!-- Leaflet.heat plugin -->
    <script src="../static/leaflet/leaflet-heat.js"></script>

    <script>
        // Initialize the map
        const map = L.map('map', {
            minZoom: 2,
            maxZoom: 22  // Increased max zoom level
        }).setView([0, 0], 2);
        L.tileLayer('http://{s}.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
            maxZoom: 22,
            subdomains:['mt0','mt1','mt2','mt3']
        }).addTo(map);

        // Store markers and paths
        let markers = [];
        let paths = {};
        let markersVisible = true; // Track marker visibility state
        let pathsVisible = true;   // Track path visibility state
        let heatmapVisible = false; // Track heatmap visibility state
        let heatmapLayer = null;   // Heatmap layer reference
        let heatmapIntensity = 15; // Default heat intensity

        // Error code descriptions
        const errorCodes = {
            0: "No error",
            1: "Outside working area",
            2: "No loop signal",
            3: "Wrong loop signal",
            4: "Loop sensor problem, front",
            5: "Loop sensor problem, rear",
            6: "Loop sensor problem, left",
            7: "Loop sensor problem, right",
            8: "Wrong PIN code",
            9: "Trapped",
            10: "Upside down",
            11: "Low battery",
            12: "Empty battery",
            13: "No drive",
            14: "Mower lifted",
            15: "Lifted",
            16: "Stuck in charging station",
            17: "Charging station blocked"
        };

        // Initialize by loading mowers and map data
        async function initialize() {
            await loadMowers();
            await updateMap();
        }

        // Load mower list
        async function loadMowers() {
            try {
                const response = await fetch('/api/mowers');
                const mowers = await response.json();

                const mowerSelect = document.getElementById('mower-select');

                // Clear existing options except "All Mowers"
                while (mowerSelect.options.length > 1) {
                    mowerSelect.remove(1);
                }

                // Add mowers to dropdown
                mowers.forEach(mower => {
                    const option = document.createElement('option');
                    option.value = mower.mower_id;
                    option.textContent = mower.name;
                    mowerSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error loading mowers:', error);
            }
        }

        // Update map with positions
        async function updateMap() {
            // Update last updated time
            const now = new Date();
            document.getElementById('last-updated').textContent = `Last updated: ${now.toLocaleString()}`;

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Clear existing paths
            Object.values(paths).forEach(path => map.removeLayer(path));
            paths = {};

            // Clear existing heatmap
            if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
                heatmapLayer = null;
            }

            // Get selected time range and mower
            const hours = document.getElementById('time-range').value;
            const mowerId = document.getElementById('mower-select').value;

            // Build URL
            let url = `/api/positions?hours=${hours}`;
            if (mowerId) {
                url += `&mower_id=${mowerId}`;
            }

            try {
                const response = await fetch(url);
                const positions = await response.json();

                if (positions.length === 0) {
                    alert('No positions found for the selected time range and mower.');
                    return;
                }

                // Prepare data for heatmap
                const heatmapData = positions.map(pos => [
                    pos.latitude,
                    pos.longitude,
                    1 // Default intensity
                ]);

                // Create heatmap layer
                heatmapLayer = L.heatLayer(heatmapData, {
                    radius: 25,
                    blur: 15,
                    maxZoom: 17,
                    max: heatmapIntensity,
                    gradient: {
                        0.4: 'blue',
                        0.6: 'lime',
                        0.8: 'yellow',
                        1.0: 'red'
                    }
                });

                // Only add to map if heatmap is visible
                if (heatmapVisible) {
                    heatmapLayer.addTo(map);
                }

                // Group positions by mower
                const mowerPositions = {};
                positions.forEach(pos => {
                    if (!mowerPositions[pos.mower_id]) {
                        mowerPositions[pos.mower_id] = [];
                    }
                    mowerPositions[pos.mower_id].push(pos);
                });

                // Process each mower's positions
                for (const [mowerId, positions] of Object.entries(mowerPositions)) {
                    // Sort positions by time
                    positions.sort((a, b) => new Date(a.time) - new Date(b.time));

                    // Create path
                    const pathPoints = positions.map(pos => [pos.latitude, pos.longitude]);
                    const path = L.polyline(pathPoints, {
                        color: getRandomColor(),
                        weight: 3,
                        opacity: 0.7
                    });

                    // Only add path to map if paths are visible
                    if (pathsVisible) {
                        path.addTo(map);
                    }

                    paths[mowerId] = path;

                    // Add markers for each position
                    positions.forEach(pos => {
                        const marker = L.circleMarker([pos.latitude, pos.longitude], {
                            radius: 5,
                            fillColor: pos.error_code > 0 ? '#f44336' : '#4CAF50',
                            color: '#fff',
                            weight: 1,
                            opacity: 1,
                            fillOpacity: 0.8
                        });

                        // Store mower ID and time for status lookup
                        marker.mowerId = pos.mower_id;
                        marker.timestamp = pos.time;

                        // Add hover event
                        marker.on('mouseover', showMowerStatus);
                        marker.on('mouseout', hideTooltip);

                        // Only add marker to map if markers are visible
                        if (markersVisible) {
                            marker.addTo(map);
                        }
                        markers.push(marker);
                    });
                }

                // Fit map to show all markers
                if (markers.length > 0) {
                    const group = L.featureGroup(markers);
                    map.fitBounds(group.getBounds());
                }
            } catch (error) {
                console.error('Error loading positions:', error);
            }
        }

        // Show mower status on hover
        async function showMowerStatus(e) {
            const marker = e.target;

            try {
                const response = await fetch(`/api/status/${marker.mowerId}`);
                const status = await response.json();

                // Format time
                const time = new Date(marker.timestamp).toLocaleString();

                // Create tooltip content
                let content = `
                    <div class="info-box">
                        <h4>${status.name}</h4>
                        <p><strong>Model:</strong> ${status.model}</p>
                        <p><strong>Time:</strong> ${time}</p>
                        <p><strong>Battery:</strong> ${status.battery_percent}%</p>
                        <div class="battery-indicator" style="width: ${status.battery_percent}%"></div>
                        <p><strong>Mode:</strong> ${status.mode}</p>
                        <p><strong>Activity:</strong> ${status.activity}</p>
                        <p><strong>State:</strong> ${status.state}</p>
                `;

                // Add error information if there's an error
                if (status.error_code > 0) {
                    const errorDesc = errorCodes[status.error_code] || `Unknown error (${status.error_code})`;
                    content += `<p class="error"><strong>Error:</strong> ${errorDesc}</p>`;
                }

                content += `</div>`;

                // Show tooltip
                const tooltip = L.popup()
                    .setLatLng(marker.getLatLng())
                    .setContent(content)
                    .openOn(map);

                marker.tooltip = tooltip;
            } catch (error) {
                console.error('Error loading mower status:', error);
            }
        }

        // Hide tooltip on mouseout
        function hideTooltip(e) {
            const marker = e.target;
            if (marker.tooltip) {
                map.closePopup(marker.tooltip);
                marker.tooltip = null;
            }
        }

        // Generate random color for paths
        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }

        // Toggle marker visibility
        function toggleMarkers() {
            markersVisible = document.getElementById('show-markers').checked;
            markers.forEach(marker => {
                if (markersVisible) {
                    marker.addTo(map);
                } else {
                    map.removeLayer(marker);
                }
            });
        }

        // Toggle path visibility
        function togglePaths() {
            pathsVisible = document.getElementById('show-paths').checked;
            Object.values(paths).forEach(path => {
                if (pathsVisible) {
                    path.addTo(map);
                } else {
                    map.removeLayer(path);
                }
            });
        }

        // Toggle heatmap visibility
        function toggleHeatmap() {
            heatmapVisible = document.getElementById('show-heatmap').checked;
            if (heatmapVisible && heatmapLayer) {
                heatmapLayer.addTo(map);
            } else if (heatmapLayer) {
                map.removeLayer(heatmapLayer);
            }
        }

        // Update heatmap intensity
        function updateHeatmapIntensity(value) {
            heatmapIntensity = parseInt(value);
            // Need to recreate the heatmap with new intensity
            if (heatmapVisible && heatmapLayer) {
                updateMap();
            }
        }

        // Initialize the map when the page loads
        window.onload = initialize;
    </script>
</body>
</html>